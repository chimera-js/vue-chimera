!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios")):"function"==typeof define&&define.amd?define(["exports","axios"],t):t((e=e||self).VueChimera={},e.Axios)}(this,(function(e,t){"use strict";var r="default"in t?t.default:t;function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function u(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?u(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function y(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function v(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function m(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var b=(e,t,r)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let n,i;r=r||{};let o=[];return function(){const s=this,a=arguments;return new Promise(c=>{const u=r.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=r.leading?n:e.apply(s,a);for(c of o)c(t);o=[]},t),u?(n=e.apply(s,a),c(n)):o.push(c)})}};function g(e){return"object"===n(e)&&e&&"[object Object]"===Object.prototype.toString(e)}var O=function(e,t){return t in(e||{})};function j(e){try{var t=window;return e.split(".").forEach((function(e){t=t[e]})),t}catch(e){}return null}function _(e){return e}function w(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];(t=console).warn.apply(t,["[Chimera]: "+e].concat(n))}var k={request:function(e){var n,i,o="function"==typeof(n=e.axios)?"function"==typeof n.request?n:n():g(n)?r.create(n):r,s={url:(i=e).url,method:i.method,baseURL:i.baseURL,headers:i.requestHeaders,timeout:i.timeout};return Object.keys(s).forEach((function(e){void 0===s[e]&&delete s[e]})),s["get"!==(e.method||"get")?"data":"params"]=e.params,s.cancelToken=new t.CancelToken((function(t){e._canceler=t})),o.request(s).catch((function(e){throw Object.assign(e,e.response)}))},cancel:function(e){"function"==typeof e._canceler&&e._canceler(),e._canceler=null},isCancelError:function(e){return r.isCancel(e)},isTimeoutError:function(e){return e.message&&!e.response&&-1!==e.message.indexOf("timeout")}},C={status:null,data:null,headers:void 0,error:null,lastLoaded:void 0},E=function(){function e(t,r){if(i(this,e),"string"==typeof t&&(t={url:t,key:t}),!t)throw w("Invalid options",t),new Error("[Chimera]: invalid options");var n=t=this.options?this.constructor.applyDefaults(this.options,t):t,o=n.debounce,s=n.transformer,a=n.interval,c=n.headers,u=n.on,h=n.auto,f=n.prefetch,l=d(n,["debounce","transformer","interval","headers","on","auto","prefetch"]);if(l.method=(l.method||"get").toLowerCase(),this.fetchDebounced=!1!==o?b(this.fetch.bind(this),o||50,{leading:!0}):this.fetch,this.setTransformer(s),this.prefetched=!1,this.loading=!1,this.listeners=Object.create(null),g(u))for(var p in u)this.on(p,u[p]);Object.assign(this,l),this.requestHeaders=c,this.auto="string"==typeof h?h.toLowerCase()===l.method:!!h,this.prefetch=null!=f?f:this.auto,Object.assign(this,C,r||{}),a&&this.startInterval(a)}return s(e,[{key:"setTransformer",value:function(e){if("function"==typeof e)this.responseTransformer=e,this.errorTransformer=e;else if(g(e)){var t=e.response,r=e.error;this.responseTransformer=t||_,this.errorTransformer=r||_}else this.responseTransformer=_,this.errorTransformer=_}},{key:"on",value:function(e,t){return this.listeners[e]=(this.listeners[e]||[]).concat(t),this}},{key:"emit",value:function(e){var t=this;(this.listeners[e]||[]).forEach((function(r){r(t,e)}))}},{key:"fetch",value:function(e,t){var r=this;if(this.cache&&!e){var n=this.getCache();if(n)return this.setResponse(n,!0),Promise.resolve(n)}var i=this;return g(t)&&(i=Object.create(this),t.params&&(t.params=Object.assign({},i.params,t.params)),t.headers&&(t.requestHeaders=Object.assign({},i.requestHeaders,t.headers)),Object.assign(i,t)),this.loading=!0,this.emit("loading"),this.http.request(i).then((function(e){return r.loading=!1,r.setResponse(e,!0),r.setCache(e),r.emit("success"),e})).catch((function(e){throw r.loading=!1,r.setResponse(e,!1),r.http.isCancelError(e)?r.emit("cancel"):(r.http.isTimeoutError&&r.emit("timeout"),r.emit("error")),e}))}},{key:"reload",value:function(e){return this.fetchDebounced(e)}},{key:"send",value:function(e){return this.fetch(!0,{params:e})}},{key:"cancel",value:function(){this.http.cancel(this)}},{key:"getCacheKey",value:function(){if(this.key)return this.key;throw new Error('[Chimera]: cannot use cache without "key" property')}},{key:"getCache",value:function(){return this.cache?this.cache.getItem(this.getCacheKey()):void 0}},{key:"setCache",value:function(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}},{key:"deleteCache",value:function(){this.cache&&this.cache.removeItem(this.getCacheKey())}},{key:"setResponse",value:function(e,t){e=e||{},this.status=e.status,this.data=t?this.responseTransformer(e.data,this):null,this.error=t?null:this.errorTransformer(e.data,this),this.headers=this.light?void 0:e.headers||{},this.lastLoaded=this.light?void 0:new Date}},{key:"startInterval",value:function(e){var t=this;if("number"!=typeof e)throw new Error("[Chimera]: interval should be number");"undefined"!=typeof process&&process.server||(this._interval=e,this.stopInterval(),this._interval_id=setInterval((function(){return t.reload(!0)}),this._interval))}},{key:"stopInterval",value:function(){this._interval_id&&(clearInterval(this._interval_id),this._interval_id=null,this._interval=!1)}},{key:"toString",value:function(){return JSON.stringify(this.response)}},{key:"looping",get:function(){return!!this._interval}},{key:"response",get:function(){return function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=Object.assign.apply(Object,[{}].concat(t));return Object.keys(t[0]).reduce((function(e,t){return e[t]=n[t],e}),{})}(C,this)}}],[{key:"applyDefaults",value:function(e,t){if(!e)return t;t=h({},t);var r=this.optionMergeStrategies;return Object.keys(e).forEach((function(n){t[n]=n in t&&r[n]?r[n](e[n],t[n]):n in t?t[n]:e[n]})),t}}]),e}();E.prototype.http=k;var P=E.optionMergeStrategies={};P.headers=P.params=P.transformers=function(e,t){return g(e)&&g(t)?h({},e,{},t):void 0===t?e:t},P.on=function(e,t){var r=h({},e||{});return Object.entries(t||{}).forEach((function(e){var t=v(e,2),n=t[0],i=t[1],o=r[n];r[n]=o?[].concat(o).concat(i):i})),r};var x=function(e){function t(){return i(this,t),y(this,l(t).call(this,{}))}return f(t,e),s(t,[{key:"fetch",value:function(e){return Promise.reject(new Error("[Chimera]: Fetching null endpoint"))}},{key:"cancel",value:function(){}}]),t}(E),S=function(e){return e.auto&&(!e.prefetched||"override"===e.prefetch)},$=function(){function e(t,r,n){var o=this,s=c({},r);if(i(this,e),this._vm=t,this._watchers=[],n){var a=n.deep,u=n.ssrContext,h=d(n,["deep","ssrContext"]),p=this.LocalEndpoint=function(e){function t(){return i(this,t),y(this,l(t).apply(this,arguments))}return f(t,e),t}(E);p.prototype.options=p.applyDefaults(p.prototype.options,h),Object.assign(this,JSON.parse(JSON.stringify({deep:a,ssrContext:u})))}this._ssrContext=j(this.ssrContext),this._server=t.$isServer;var v={immediate:!0,deep:this._deep,sync:!0},m=function(e){if("$"===e.charAt(0))return delete s[e],"continue";var t=s[e];"function"==typeof t?o._watchers.push([function(){return t.call(o._vm)},function(t,r){return o.updateEndpoint(e,t,r)},v]):(t=s[e]=o.endpointFrom(t),o._server||S(t)&&t.reload())};for(var b in s)m(b);Object.defineProperty(s,"$cancelAll",{value:function(){return o.cancelAll()}}),Object.defineProperty(s,"$loading",{get:function(){return!!Object.values(this).find((function(e){return!!e.loading}))}}),this.endpoints=s}return s(e,[{key:"init",value:function(){var e=this;this._watchers=this._watchers.map((function(t){var r;return(r=e._vm).$watch.apply(r,m(t))}))}},{key:"initServer",value:function(){var e=this;this._vm.$_chimeraPromises=[],Object.values(this.endpoints).forEach((function(t){if(t.auto&&t.prefetch){if(!t.key)return void w("used prefetch with no key associated with endpoint!");e._vm.$_chimeraPromises.push(t.fetch(!0,{timeout:t.prefetchTimeout}).then((function(){return t})).catch((function(){return null})))}}))}},{key:"updateEndpoint",value:function(e,t,r){var n=this.endpoints[e],i=this.endpointFrom(t,r&&r.keepData?n.response:null);r&&n&&(n.stopInterval(),i.lastLoaded=n.lastLoaded),this._server||S(i)&&i.reload(),this._vm.$set(this.endpoints,e,i)}},{key:"endpointFrom",value:function(e,t){var r=this;if(null==e)return new x;if("string"==typeof e&&(e={url:e}),g(e.on)){var n=function(e){return"function"==typeof e&&(e=e.bind(r._vm)),"string"==typeof e&&(e=r._vm[e]),e};Object.entries(e.on).forEach((function(t){var r=v(t,2),i=r[0],o=r[1];e.on[i]=Array.isArray(o)?o.map(n):n(o)}))}var i=new(this.LocalEndpoint||E)(e,t);return!this._server&&!t&&i.key&&i.prefetch&&this._ssrContext&&((t=this._ssrContext[e.key])&&(t.prefetched=!0),Object.assign(i,t)),i}},{key:"cancelAll",value:function(){Object.values(this.endpoints).forEach((function(e){e.cancel()}))}},{key:"destroy",value:function(){var e=this._vm;this.cancelAll(),Object.values(this.endpoints).forEach((function(e){e.stopInterval()})),delete e._chimera}}]),e}(),T={beforeCreate:function(){var e,t=this,r=this.$options;if(r.chimera&&!r._chimera){if("function"==typeof r.chimera&&(r.chimera=r.chimera.call(this)),!g(r.chimera))throw new Error("[Chimera]: chimera options should be an object or a function that returns object");var n=r.chimera,i=n.$options,o=d(n,["$options"]);e=new $(this,o,i),Object.prototype.hasOwnProperty.call(this,"$chimera")||Object.defineProperty(this,"$chimera",{get:function(){return e.endpoints}}),Object.keys(e.endpoints).forEach((function(e){O(r.computeds,e)||O(r.props,e)||O(r.methods,e)||Object.defineProperty(t,e,{get:function(){return t.$chimera[e]},enumerable:!0,configurable:!0})})),this._chimera=e}},data:function(){return this._chimera?{$chimera:this._chimera.endpoints}:{}},created:function(){this._chimera&&(this._chimera.init(),this.$isServer&&this._chimera.initServer())},beforeDestroy:function(){this._chimera&&this._chimera.destroy()},serverPrefetch:function(){if(this.$_chimeraPromises){var e=require("../ssr/index");return Promise.all(this.$_chimeraPromises).then((function(t){t.forEach((function(t){t&&e.addEndpoint(t)}))}))}}},A={inheritAttrs:!1,props:{options:{type:[Object,String]},tag:{type:String,default:null},ssrContext:{type:String,default:null}},data:function(){return{endpoint:this.getEndpoint()}},render:function(e){var t=this.$scopedSlots.default(this.endpoint);return t=Array.isArray(t)?t.concat(this.$slots.default):[t].concat(this.$slots.default),this.tag?e(this.tag,t):t[0]},created:function(){var e=this.endpoint;this.$isServer&&e.key&&(this.$_chimeraPromises=[e.fetch(!0).then((function(){return e})).catch((function(){return null}))])},mounted:function(){var e=this.endpoint;!e.auto||e.data&&"override"!==e.prefetch||e.reload()},methods:{getEndpoint:function(){var e=this,t=this.options;if(null==t)return new x;"string"==typeof t&&(t={url:t});var r=new E(t);if(r.emit=function(t){E.prototype.emit.call(r,t),e.$emit(t,r)},this._ssrContext=j(this.ssrContext||$.prototype.ssrContext),!this._server&&r.key&&r.prefetch&&this._ssrContext){var n=this._ssrContext[r.key];n&&(n.prefetched=!0),Object.assign(r,n)}return r}}},I={cache:null,debounce:50,deep:!0,keepData:!0,auto:"get",prefetch:!0,prefetchTimeout:4e3,transformer:null,ssrContext:null};function D(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=Object.assign({},I,t),e.mixin(T),e.component("chimera-endpoint",A);var r=t,n=r.deep,i=r.ssrContext,o=d(r,["deep","ssrContext"]);E.prototype.options=o,Object.assign($.prototype,{deep:n,ssrContext:i}),e.config.optionMergeStrategies.chimera=function(e,t,r){return e?t?("function"==typeof t&&(t=t.call(r)),"function"==typeof e&&(e=e.call(r)),Object.assign({},e,t,e.$options&&t.$options?{$options:E.applyDefaults(e.$options,t.$options)}:{})):e:t}}e.ChimeraEndpoint=A,e.Endpoint=E,e.default=D,e.install=D,Object.defineProperty(e,"__esModule",{value:!0})}));
